# 良策AI分析平台 - 微信小程序移植技术方案

本文档基于对现有Vue Web项目的深入分析，为"良策AI分析平台"向微信小程序的移植工作提供一套完整、可行的技术方案。

## 1. 总体架构

我们将采用**微信小程序原生框架 + 后端BFF (Backend for Frontend)** 的架构。这与原Web项目的架构思想保持一致，可以最大程度地复用后端的业务逻辑。

*   **小程序端**:
    *   **开发框架**: 使用微信小程序原生框架，不引入额外的第三方框架（如Taro、uni-app），以保证最佳性能和兼容性。
    *   **UI组件库**: 选用微信官方或社区推荐的优秀UI库，如 `WeUI` 或 `Vant Weapp`，来替代Web项目中的 `Element Plus`，快速构建符合小程序设计规范的界面。
    *   **开发语言**: 推荐使用 `TypeScript` 提升代码质量和可维护性。

*   **后端BFF层**:
    *   **完全复用**: 现有的 `server.js` 及其依赖（如 `documentService.js`, `prompts`配置等）**可以几乎不做修改地完全复用**。这是本次移植工作的最大优势。
    *   **部署**: BFF层需要独立部署在一个Node.js服务器上，并通过HTTPS协议为小程序提供API接口。

## 2. 小程序端技术实现细节

### 2.1. 项目结构

建议采用官方推荐的小程序目录结构，并结合业务进行组织：

```
miniprogram/
├── app.js
├── app.json
├── app.wxss
├── components/                 # 全局复用组件
│   ├── NavigationBar/          # 自定义导航栏
│   └── ...
├── pages/                      # 页面
│   ├── home/                   # 首页
│   ├── analyse/                # 核心分析页面 (承载四步流程)
│   └── ...
├── services/                   # 服务层
│   ├── api.js                  # API请求封装
│   └── stream.js               # 流式请求处理
├── utils/                      # 工具函数
└── ...
```

### 2.2. 页面与路由映射

| 原Web项目路由        | 对应小程序页面         | 页面功能描述                                   |
| -------------------- | ---------------------- | ---------------------------------------------- |
| `/`                  | `pages/home/home`      | 应用首页，提供四大功能入口                     |
| `/personal-credit`   | `pages/analyse/analyse` | 个人征信分析（通过参数区分业务类型）           |
| `/business-credit`   | `pages/analyse/analyse` | 企业征信分析（通过参数区分业务类型）           |
| `/property-advice`   | `pages/analyse/analyse` | 房产建议（通过参数区分业务类型）               |
| `/finance-advice`    | `pages/analyse/analyse` | 融资建议（通过参数区分业务类型）               |
| (内置工具)           | `pages/tools/loanCalculator` | 贷款计算器，可从分析页面独立打开             |
| (历史记录)           | (集成在`analyse`页面中) | 历史记录面板，用于关联征信报告                 |
| `/task-result`       | (集成在`analyse`页面中) | 分析结果展示页，是`analyse`流程的第四步        |

**关键决策**: 将原项目中多个独立的分析页面 (`PersonalCredit.vue`, `BusinessCredit.vue`等) **合并为一个小程序中的 `pages/analyse/analyse` 页面**。通过从`home`页传递过来的参数 (`type=personal-credit` 等) 来动态调整页面标题、上传提示和调用的后端 `chatType`。这种方式能极大提升代码复用率。
**该 `analyse` 页面需要支持多种视图模式**：征信上传模式、顾问报告输入模式、分析流程模式（步骤2-4）。

### 2.3. 核心功能实现方案

#### 2.3.1. 智能表单与多阶段提交流程

*   **需求**: 实现顾问报告类功能的引导式输入、AI预分析、关联历史报告等复杂逻辑。
*   **小程序实现方案**:
    1.  **动态视图**: 在 `pages/analyse/analyse.wxml` 中，使用 `wx:if` 根据当前的功能类型 (`type`) 和表单状态 (`formStage`) 来切换不同的UI布局。例如：`formStage` 可以是 `filling` (填写中), `extracting` (AI预分析中), `confirming` (待确认)。
    2.  **引导式输入**: 左右两栏布局在小程序中可以用 `view` 结合 `flex` 布局实现。右侧的"建议"内容可以是静态的，而"历史记录"列表则需要动态获取。
    3.  **历史记录选择**: 当用户点击"关联征信报告"时，可以从屏幕右侧滑出一个面板（使用CSS动画），面板中用 `scroll-view` 展示一个可滚动的历史记录列表。列表数据通过新的BFF接口 `/api/history` 获取。
    4.  **API协同**:
        *   "AI分析需求"按钮调用一个新的BFF接口，如 `/api/extract-keywords`，只做关键词提取，不生成最终报告。
        *   最终的"生成报告"按钮则调用现有的 `/api/chat` 或 `/api/chat-stream` 接口，并将需求描述、结构化信息、关联的征信报告ID一同提交。

#### 2.3.2. 文件上传 (API: `wx.uploadFile`)

*   代替原Web项目中的 `axios`+`FormData` 上传方式。
*   使用微信小程序的 `wx.uploadFile` API，它可以直接将用户选择的文件（通过`wx.chooseMedia`或`wx.chooseMessageFile`获取）上传到我们的BFF服务器的 `/api/upload` 接口。
*   `wx.uploadFile` 自带上传进度回调，可以方便地实现上传进度的实时展示。

#### 2.3.3. AI流式响应处理

这是本项目的技术难点和亮点，在小程序中实现需要特殊处理。

*   **问题**: 微信小程序的 `wx.request` API **不支持流式响应 (stream)**。
*   **解决方案**:
    1.  **后端适配**: 维持BFF中 `/api/chat-stream` 接口的流式输出不变。
    2.  **前端轮询 (不推荐)**: 实现复杂，延迟高，体验差。
    3.  **WebSocket (推荐)**: 在BFF中增加一个WebSocket服务。小程序端与BFF建立WebSocket长连接。当AI生成流式数据时，BFF通过WebSocket通道实时推送到小程序端。
    4.  **Fetch API Polyfill (最佳方案)**: 在小程序中引入一个轻量级的 `fetch` polyfill，利用其支持 `ReadableStream` 的特性来接收流式数据。这需要一个支持 `chunked` 传输的HTTP库。社区已有成熟的解决方案（如 `wechat-miniprogram-fetch`），可以模拟实现流式接收。

**方案选型**: 优先采用 **方案4 (Fetch API Polyfill)**，因为它对后端改动最小，且能最大程度还原Web项目的实时"打字机"效果。

#### 2.3.4. Markdown内容渲染

*   **问题**: 小程序环境无法直接渲染HTML (`v-html`)。
*   **解决方案**: 引入小程序的 **Markdown渲染组件**，如 `towxml` 或 `mp-html`。这些组件可以将Markdown文本解析并渲染为符合小程序规范的WXML结构，并支持代码高亮、表格等复杂样式。

#### 2.3.5. 全局AI聊天功能

*   **需求**: Web项目中，用户可点击右上角头像菜单，在任何页面唤起一个全局AI聊天窗口。
*   **小程序实现方案**:
    1.  **UI形式**: 在小程序的 `pages/home` 和 `pages/analyse` 等主要页面中，设置一个全局悬浮按钮（Floating Action Button, FAB）。这个按钮可以是一个AI或聊天的图标。
    2.  **唤起方式**: 用户点击该悬浮按钮后，从底部弹出一个半屏弹窗 (`half-screen-dialog`) 作为聊天界面。这种方式体验好，且不会完全中断用户在当前页面的操作。
    3.  **组件化**: 将整个"悬浮按钮 + 半屏聊天窗口"封装成一个自定义组件，在需要的页面中直接引入即可。聊天窗口内部的逻辑（消息发送、流式接收、内容展示）可以复用`analyse`页面的咨询功能逻辑。

### 2.4. 状态管理

*   对于复杂的分析页面 (`analyse`)，其内部的四步流程状态 (`activeStep`, `extractedText`, `reportContent` 等) 可以使用页面自身的 `data` 和 `setData` 进行管理。
*   如果未来有跨页面共享状态的需求（例如用户信息），可以引入轻量级的全局状态管理库，如 `mobx-miniprogram`。

## 3. 后端BFF层

*   **无需改动**: 核心的 `server.js`, `documentService.js`, `deepseek.js` 和 `prompts` 文件夹都可以直接复用。
*   **配置修改**:
    *   在 `server.js` 的 `cors` 配置中，需要确保允许来自 `servicewechat.com` (微信小程序官方域名) 的请求。
    *   `.env` 文件需要配置好 `DEEPSEEK_API_KEY`。
*   **部署**: 必须将BFF部署在公网可访问的服务器上，并配置HTTPS证书，因为微信小程序强制要求所有API请求必须是HTTPS。

## 4. AI Prompt工程体系 (项目核心)

**这是`liangceAI`项目的核心与灵魂**。BFF的主要职责并非执行复杂的业务逻辑，而是作为一个**"智能Prompt路由器"**。接手项目的开发者必须理解这一点。

*   **工作原理**: BFF根据前端请求的业务类型（如`type=property-advice`）和当前所处的业务阶段（如是"预分析"还是"生成报告"），动态加载`src/config/prompts/`目录下对应的`js`文件，生成高度定制化的指令，然后发送给DeepSeek AI。
*   **多Prompt协同**: 一个完整的复杂业务（如房产顾问），是由多个Prompt协同完成的：
    1.  使用 `propertyNeedsAnalytics.js` 进行**需求预分析和结构化**。
    2.  使用 `property-advice.js` 生成**最终的详细报告**。
    3.  使用 `followup-chat.js` 处理报告生成后的**多轮追问**，并保持上下文。
*   **移植建议**: **此体系应100%在BFF后端复用**。小程序端无需关心具体的Prompt内容，只需要在正确的时间，向BFF的正确接口发送请求即可。

## 5. UI/UX 效果与交互细节移植建议

Web项目在UI/UX方面经过了精心设计，包含大量提升用户体验的细节。为了在小程序中保持同样的高品质感受，特将这些关键效果总结如下，并提出移植建议：

### 5.1. 加载与反馈动画
*   **Web端效果**: 在AI思考或数据加载时，使用了丰富的加载动画，如骨架屏（Skeleton）、自定义的"AI大脑思考"SVG动画、耗时计时器等。
*   **小程序移植建议**:
    *   **保留骨架屏**: 这是一个非常现代的加载模式，体验优于传统"菊花"加载。可使用UI库（如Vant Weapp）提供的`van-skeleton`组件。
    *   **适配动画**: 复杂的SVG动画可以转换为小程序支持的CSS动画或使用`Lottie`动画库来高效实现，避免使用GIF导致体积过大。
    *   **保留计时器**: 耗时计时器是建立用户信任感的重要细节，应予以保留。

### 5.2. 核心交互模式
*   **Web端效果**:
    *   报告查看器页面采用了"左/"右"、"上/"下"均可**拖拽调整大小**的分栏布局。
    *   全局AI聊天是一个**可拖拽的悬浮窗口**。
*   **小程序移植建议**:
    *   **放弃拖拽分栏**: 受限于移动端屏幕和交互方式，拖拽调整布局不现实。可调整为：
        *   使用**标签页（Tabs）**切换"分析报告"和"AI思考过程"。
        *   或使用**可折叠面板（Collapse）**，用户可以展开或收起"AI思考过程"和"继续咨询"区域。
    *   **适配聊天窗口**: 全局聊天窗口已在方案中确定，使用**全局悬浮按钮（FAB）+ 半屏弹窗**的形式，这是移动端最佳实践。

### 5.3. 过渡与微交互
*   **Web端效果**:
    *   面板（如历史记录、聊天窗口）的出现/消失带有**淡入淡出**的过渡效果。
    *   首页功能卡片在鼠标**悬浮（Hover）**时有动效。
    *   顾问报告表单中的"就地编辑"（Click-to-Edit）功能。
    *   征信报告上传图片后，支持**拖拽排序**。
*   **小程序移植建议**:
    *   **保留过渡动画**: 面板的弹出和收回可以使用CSS `transition` 来实现平滑的动画效果，提升体验。
    *   **适配Hover效果**: 小程序没有鼠标悬仿，可将此效果改为用户**触摸时（`:active`伪类）**的视觉反馈，如轻微缩放或颜色变深。
    *   **保留"就地编辑"**: 这个交互可以在小程序中实现。通过点击文本，切换`view`和`input`的显示状态即可。这是提升"掌控感"的关键设计，应予以保留。
    *   **实现拖拽排序**: 这是征信分析流程中的关键体验。可以使用小程序官方提供的 `movable-view` 和 `movable-area` 组件来实现。将图片列表渲染为一系列 `movable-view`，通过监听它们的触摸和移动事件，动态计算位置并更新图片数组的顺序。社区也有一些成熟的拖拽排序组件库可供选择。 