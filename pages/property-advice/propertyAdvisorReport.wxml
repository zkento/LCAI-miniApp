<navigation-bar id="nav-bar" title="è´­æˆ¿å»ºè®®æŠ¥å‘Š" background="#f8f9fa" bind:back="onBack"></navigation-bar>
<scroll-view scroll-y="true" class="scroll-container" style="height: {{scrollViewHeight}}">
  <view class="property-advisor-report">
    <!-- å¤„ç†æ­¥éª¤åŒºåŸŸ - åªåœ¨ç¬¬ä¸€æ­¥ä¹‹åæ˜¾ç¤º -->
    <view class="steps-header" wx:if="{{activeStep > 1}}">
      <view class="steps-container">
        <view class="step-item {{activeStep >= 1 ? 'active' : ''}}">
          <view class="step-number">1</view>
          <text class="step-title">æäº¤å®¢æˆ·éœ€æ±‚</text>
        </view>
        <view class="step-line {{activeStep >= 2 ? 'active' : ''}}"></view>
        <view class="step-item {{activeStep >= 2 ? 'active' : ''}}">
          <view class="step-number">2</view>
          <text class="step-title">AIæ€è€ƒåˆ†æ</text>
        </view>
        <view class="step-line {{activeStep >= 3 ? 'active' : ''}}"></view>
        <view class="step-item {{activeStep >= 3 ? 'active' : ''}}">
          <view class="step-number">3</view>
          <text class="step-title">è´­æˆ¿å»ºè®®æŠ¥å‘Š</text>
        </view>
      </view>
    </view>

    <!-- å„æ­¥éª¤å¯¹åº”çš„å†…å®¹åŒºåŸŸ -->
    <view class="step-content">
      <!-- æ­¥éª¤2: AIæ€è€ƒåˆ†æï¼ŒåŒ¹é…æˆ¿äº§ -->
      <view wx:if="{{activeStep === 2}}" class="step-container">
        <view class="ai-thinking-container">
          <!-- åŒ¹é…äº§å“çš„è’™å±‚ï¼Œå½“AIæœªå¼€å§‹è¿”å›æ€è€ƒè¿‡ç¨‹çš„å†…å®¹å‰æ˜¾ç¤º -->
          <view wx:if="{{workingStatus === 'working'}}" class="working-overlay">
            <view class="overlay-content">
              <view class="animation-container">
                <view class="loading-brain">
                  <view class="brain-icon">ğŸ§ </view>
                  <view class="loading-dots">
                    <view class="dot"></view>
                    <view class="dot"></view>
                    <view class="dot"></view>
                  </view>
                </view>
              </view>
              <view class="wait-footer">
                <view class="ai-tip">æ­£åœ¨ç­‰å¾…AIå“åº”ï¼Œè¯·ç¨ç­‰...</view>
                <view class="ai-timer">
                  <text class="timer-icon">â±ï¸</text>
                  <text>å·²è€—æ—¶ {{workingTimer}} ç§’</text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- AIæ€è€ƒè¿‡ç¨‹å†…å®¹å®¹å™¨ï¼Œå½“æ€è€ƒæ¨¡å¼å¼€å§‹åæ˜¾ç¤º -->
          <view wx:if="{{workingStatus === 'thinking' || workingStatus === 'generating'}}" class="thinking-container">
            <view class="panel-header">
              <text class="header-icon">ğŸ¤–</text>
              <text wx:if="{{isThinking}}" class="thinking-status">AIæ­£åœ¨æ·±åº¦æ€è€ƒä¸­...</text>
              <text wx:elif="{{workingStatus === 'generating'}}" class="thinking-completed">AIæ€è€ƒå·²å®Œæˆã€‚</text>
            </view>
            <view class="panel-content">
              <!-- æŠ¥å‘Šç”Ÿæˆè¿‡æ¸¡æç¤ºï¼Œä¸é®æŒ¡æ€è€ƒå†…å®¹ï¼Œè€Œæ˜¯ä»¥æ‚¬æµ®æç¤ºå½¢å¼å±•ç¤º -->
              <view wx:if="{{workingStatus === 'generating'}}" class="generating-overlay">
                <view class="generating-content">
                  <view class="loading-spinner"></view>
                  <view class="generating-message">å³å°†ç”Ÿæˆè´­æˆ¿å»ºè®®æŠ¥å‘Š...</view>
                </view>
              </view>
              
              <view class="thinking-display {{workingStatus === 'generating' ? 'dimmed' : ''}}">
                <text class="thinking-text">{{displayedThinkingProcess}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- æ­¥éª¤3: ç”Ÿæˆæˆ¿äº§æŠ¥å‘Š -->
      <view wx:if="{{activeStep === 3}}" class="step-container">
        <view class="report-container">
          <view class="report-layout">
            <!-- å·¦ä¾§AIåˆ†æç»“æœ -->
            <view class="report-left">
              <view class="panel-header">
                <text class="panel-title">
                  ğŸ“„ è´­æˆ¿å»ºè®®æŠ¥å‘Š
                  <text wx:if="{{reportGenerationDuration > 0}}" class="report-duration">è€—æ—¶{{reportGenerationDuration}}ç§’</text>
                </text>
                <view class="header-actions">
                  <button 
                    wx:if="{{reportContent}}" 
                    class="action-button download-btn"
                    bindtap="downloadReport"
                  >ğŸ’¾ ä¸‹è½½æŠ¥å‘Š</button>
                  <button 
                    wx:if="{{reportContent}}" 
                    class="action-button restart-btn"
                    bindtap="restartAdvisor"
                  >ğŸ  æ–°çš„ä»»åŠ¡</button>
                </view>
              </view>
              <view class="panel-content">
                <view class="report-content">
                  <text class="report-text">{{reportContent}}</text>
                </view>
              </view>
            </view>
            
            <!-- å³ä¾§åŒºåŸŸï¼ˆAIæ€è€ƒè¿‡ç¨‹å’Œå’¨è¯¢ï¼‰-->
            <view class="report-right">
              <!-- ä¸Šéƒ¨åˆ†ï¼šAIåŒ¹é…äº§å“æ€è€ƒè¿‡ç¨‹ -->
              <view class="report-right-top" style="height: {{verticalSplit}}%">
                <view class="panel-header">
                  <text class="panel-title">ğŸ§  AIæ·±åº¦æ€è€ƒè¿‡ç¨‹</text>
                </view>
                <view class="panel-content">
                  <view class="thinking-content">
                    <view wx:if="{{workThinkingContent}}" class="work-thinking">
                      <text class="thinking-text">{{workThinkingContent}}</text>
                    </view>
                    <view wx:for="{{consultationThinkingProcesses}}" wx:key="index" class="consultation-thinking">
                      <view wx:if="{{index > 0 || workThinkingContent}}" class="thinking-separator">
                        <view class="separator-line"></view>
                        <text class="separator-text">æ–°çš„å’¨è¯¢AIæ€è€ƒè¿‡ç¨‹</text>
                        <view class="separator-line"></view>
                      </view>
                      <text class="thinking-text">{{item}}</text>
                    </view>
                  </view>
                </view>
              </view>
              
              <!-- ä¸‹éƒ¨åˆ†ï¼šç»§ç»­å‘AIå’¨è¯¢ -->
              <view class="report-right-bottom" style="height: {{100 - verticalSplit}}%">
                <view class="panel-header">
                  <text class="panel-title">
                    ğŸ’¬ ç»§ç»­å‘AIå’¨è¯¢
                    <text wx:if="{{consultationThinkingTimer > 0}}" class="thinking-status">
                      AIæ­£åœ¨å›å¤ä¸­ {{consultationThinkingTimer}}ç§’
                    </text>
                    <text wx:elif="{{consultationResponseStatus}}" class="response-status">
                      {{consultationResponseStatus}} è€—æ—¶{{consultationResponseTime}}ç§’
                    </text>
                  </text>
                </view>
                
                <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
                <view class="chat-messages">
                  <view wx:for="{{consultationMessages}}" wx:key="index" class="message {{item.role}}">
                    <view wx:if="{{item.role === 'assistant'}}" class="message-avatar">AI</view>
                    <view class="message-content">
                      <text class="message-text">{{item.content}}</text>
                    </view>
                  </view>
                  
                  <!-- AIå›å¤æ€è€ƒä¸­åŠ¨ç”» -->
                  <view wx:if="{{consultationLoading}}" class="message assistant thinking">
                    <view class="message-avatar">AI</view>
                    <view class="message-content">
                      <view class="thinking-indicator">
                        <view class="thinking-dot"></view>
                        <view class="thinking-dot"></view>
                        <view class="thinking-dot"></view>
                      </view>
                    </view>
                  </view>
                </view>

                <!-- èŠå¤©è¾“å…¥æ¡† -->
                <view class="chat-input">
                  <view class="input-container">
                    <textarea
                      class="message-input"
                      placeholder="è¯·è¾“å…¥ä½ è¦å’¨è¯¢çš„å†…å®¹..."
                      value="{{consultationInput}}"
                      bindinput="onConsultationInput"
                      auto-height
                      maxlength="500"
                    />
                    <button 
                      class="send-button {{consultationInput.trim() && !consultationLoading ? '' : 'disabled'}}" 
                      bindtap="sendConsultationMessage" 
                      disabled="{{!consultationInput.trim() || consultationLoading}}"
                    >ğŸ“¤</button>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</scroll-view> 