<navigation-bar id="nav-bar" title="融资顾问" background="#f8f9fa" bind:back="onBack"></navigation-bar>
<scroll-view
  scroll-y="true"
  class="scroll-container"
  style="height: {{scrollViewHeight}}"
  bindscroll="onScroll"
  scroll-into-view="{{scrollIntoView}}"
  scroll-with-animation="{{true}}"
>
  <view class="finance-advisor-form">
    <view class="form-container">
      <!-- 左侧输入区 -->
      <view class="input-panel">
        <view class="panel-header">
          <text class="panel-title">填写客户融资需求</text>
        </view>
        <view class="panel-content">
          <text class="description-hint">请参照右侧的需求描述建议输入客户的融资需求，信息覆盖得越全面越好。</text>
          
          <!-- 需求描述文本框 -->
          <view class="form-item">
            <textarea 
              class="requirements-textarea"
              placeholder="请用不少于10个字详细地描述客户的融资需求"
              value="{{formData.requirements}}"
              bindinput="onRequirementsInput"
              maxlength="500"
              show-count
              disabled="{{isExtractingKeywords || hasAttemptedExtraction}}"
              auto-height
              style="min-height: 200rpx;"
            />
          </view>
          
          <!-- 客户信息输入区域 -->
          <view class="client-info-section">
            <!-- 客户姓名输入框 -->
            <view class="form-item">
              <input 
                class="name-input"
                placeholder="请输入客户姓名（必填，方便你查询结果）"
                value="{{formData.name}}"
                bindinput="onNameInput"
                disabled="{{isExtractingKeywords}}"
              />
            </view>
            
            <!-- 业务地区选择 - 使用 Cascader 替换 -->
            <view class="form-item">
              <view 
                class="area-selector {{isExtractingKeywords ? 'is-disabled' : ''}} {{selectedAreaText ? 'has-value' : ''}}" 
                bindtap="openCascader"
              >
                <text wx:if="{{selectedAreaText}}" class="selected-text">{{selectedAreaText}}</text>
                <text wx:else class="placeholder-text">请选择业务城市（必填）</text>
                <view class="selector-icon">
                  <van-icon name="arrow" size="16px" color="#c0c4cc" class="van-cell__right-icon" />
                </view>
              </view>
              
              <!-- Cascader 弹出层 -->
              <van-popup
                show="{{showCascader}}"
                round
                position="bottom"
                custom-style="height: 60vh;"
                bind:close="onCloseCascader"
                z-index="999"
              >
                <van-cascader
                  value="{{cascaderValue}}"
                  title="请选择业务城市"
                  options="{{provinceOptions}}"
                  bind:close="onCloseCascader"
                  bind:finish="onFinishCascader"
                  active-color="#1b68de"
                  field-names="{{ { text: 'label', value: 'value', children: 'children' } }}"
                />
              </van-popup>
            </view>

            <!-- 征信报告分析结果选择器 -->
            <view class="form-item">
              <view
                class="credit-report-trigger {{isExtractingKeywords ? 'is-disabled' : ''}} {{selectedPersonalTask || selectedEnterpriseTask ? 'has-value' : ''}}"
                bindtap="openCreditReportPopup"
              >
                <text class="trigger-text {{selectedPersonalTask || selectedEnterpriseTask ? 'has-selected' : ''}}">
                  <block wx:if="{{selectedPersonalTask && selectedEnterpriseTask}}">已选择个人和企业的征信报告分析结果</block>
                  <block wx:elif="{{selectedPersonalTask}}">已选择"{{selectedPersonalTask.customerName}}"的"个人征信报告分析结果"</block>
                  <block wx:elif="{{selectedEnterpriseTask}}">已选择"{{selectedEnterpriseTask.customerName}}"的"企业征信报告分析结果"</block>
                  <block wx:else>请选择征信报告分析结果</block>
                </text>
                <view class="trigger-suffix">
                  <van-icon wx:if="{{selectedPersonalTask || selectedEnterpriseTask}}" name="clear" size="16px" color="#a8abb2" catchtap="clearSelectedCreditReport" />
                  <van-icon wx:else name="arrow" size="16px" color="#c0c4cc" class="van-cell__right-icon" />
                </view>
              </view>
            </view>
          </view>

          <!-- 表单按钮操作区 -->
          <view class="form-actions" style="width:100%; padding:0;">
            <block wx:if="{{!hasAttemptedExtraction}}">
              <view style="width:100%; padding:0rpx; margin-bottom:30rpx; box-sizing:border-box;">
                <button 
                  class="reset-button {{!formData.requirements && !formData.name && (!formData.businessArea || !formData.businessArea.length) && !selectedPersonalTask && !selectedEnterpriseTask ? 'is-disabled' : ''}}" 
                  bindtap="resetForm"
                  disabled="{{!formData.requirements && !formData.name && (!formData.businessArea || !formData.businessArea.length) && !selectedPersonalTask && !selectedEnterpriseTask}}"
                  style="width:100%; margin:0; box-sizing:border-box; {{(!formData.requirements && !formData.name && (!formData.businessArea || !formData.businessArea.length) && !selectedPersonalTask && !selectedEnterpriseTask) ? 'background-color:#fff !important; color:#c0c4cc !important; border:2rpx solid #e4e7ed !important; opacity:0.6 !important;' : ''}}"
                >重置</button>
              </view>
              <view style="width:100%; padding:0rpx; box-sizing:border-box;">
                <button
                  class="extract-button {{isExtractingKeywords ? 'loading' : ''}} {{!canExtractKeywords ? 'is-disabled' : ''}}"
                  bindtap="extractKeywords"
                  loading="{{isExtractingKeywords}}"
                  disabled="{{!canExtractKeywords || isExtractingKeywords}}"
                  style="width:100%; margin:0; box-sizing:border-box; {{(!canExtractKeywords || isExtractingKeywords) ? 'background-color:#1b68de !important; color:#ffffff !important; opacity:0.6 !important;' : ''}}"
                >
                  <block wx:if="{{!isExtractingKeywords}}">让AI分析客户需求</block>
                  <block wx:else>
                    AI正在提取关键词...
                    <span class="time-counter"> 用时{{currentAnalysisTime}}秒</span>
                  </block>
                </button>
              </view>
            </block>
            <block wx:else>
              <view style="width:100%; padding:0rpx; margin-bottom:30rpx; box-sizing:border-box;">
                <button class="reset-button" bindtap="resetForm" style="width:100%; margin:0; box-sizing:border-box;">新的需求</button>
              </view>
              <view style="width:100%; padding:0rpx; box-sizing:border-box;">
                <button 
                  class="submit-button {{submitting ? 'loading' : ''}} {{isExtractingKeywords ? 'is-disabled' : ''}}" 
                  bindtap="submitFinanceForm"
                  loading="{{submitting}}"
                  disabled="{{isExtractingKeywords}}"
                  style="width:100%; margin:0; box-sizing:border-box; {{isExtractingKeywords ? 'background-color:#1b68de !important; color:#ffffff !important; opacity:0.6 !important;' : ''}}"
                >
                让AI生成融资建议报告
                </button>
              </view>
            </block>
          </view>
        </view>
      </view>

      <!-- 右侧内容面板 -->
      <view class="content-panel">
        <!-- 引导内容 -->
        <view class="reference-content" wx:if="{{!hasAttemptedExtraction}}">
          <view class="panel-header">
            <text class="panel-title">融资需求描述建议</text>
          </view>
          <view class="panel-content">
            <view class="reference-section">
              <text class="section-title">需求尽可能详细地包含以下信息：</text>
              <view class="reference-items">
                <view class="reference-item">
                  <text class="item-label">贷款方式：按揭贷款、抵押贷款、信用贷款、经营贷款、消费贷款等</text>
                </view>
                <view class="reference-item">
                  <text class="item-label">融资金额与期限：需要多少资金，使用多长时间</text>
                </view>
                <view class="reference-item">
                  <text class="item-label">融资用途：资金将用于哪些方面，例如周转、扩大生产、新项目等</text>
                </view>
                <view class="reference-item">
                  <text class="item-label">企业情况：行业、规模、经营时间、近期营收情况</text>
                </view>
                <view class="reference-item">
                  <text class="item-label">现有资产：有无房产、车辆等可抵押物</text>
                </view>
                <view class="reference-item">
                  <text class="item-label">特殊要求：放款速度、利率要求、还款方式偏好</text>
                </view>
              </view>
            </view>

            <view class="example-section">
              <view class="example-block">
                <text class="section-title">融资需求描述参考示例：</text>
                <view class="example-quote" bindtap="copyExampleText">
                  <text>我是一家成立了5年的餐饮企业老板，在广州有3家连锁店，月营业额约80万元。\n现计划申请经营抵押贷款300万元用于新开2家分店，希望能在1个月内放款，期限2年以上，可接受月息最高5厘。\n目前在广州名下有一套市值约500万元的商品房可以抵押，目前无贷款，也有约50万元应收账款。希望了解银行抵押贷款和企业经营贷款哪个更合适，最快多久能拿到资金。</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- 分析结果内容 -->
        <view class="analysis-content" id="analysis-content" wx:if="{{hasAttemptedExtraction}}">
          <view class="panel-header">
            <text class="panel-title">客户需求分析结果</text>
            <view class="refresh-button-wrapper">
              <button 
                class="refresh-button {{isExtractingKeywords ? 'loading' : ''}}"
                bindtap="extractKeywords"
                disabled="{{isExtractingKeywords}}"
              >
                <block wx:if="{{!isExtractingKeywords}}">重新分析</block>
                <block wx:else>
                  <view class="loading-container">
                    <view class="custom-loading"></view>
                    <text>分析中</text>
                  </view>
                </block>
              </button>
            </view>
          </view>

          <!-- 使用 Vant Card 组件优化关键词显示 -->
          <van-card custom-class="keywords-card">
            <view slot="title" class="keywords-title">
              <view class="keywords-title-left">
                <van-icon name="tag" size="32rpx" color="#1989fa" />
                <text class="keywords-title-text">需求关键词</text>
                <text wx:if="{{extractionDuration}}" class="analysis-time">AI分析用时{{extractionDuration}}秒</text>
              </view>
            </view>
            <view slot="desc" class="keywords-content">
              <view wx:if="{{aiKeywords.length > 0}}" class="keywords-tags">
                <van-tag
                  wx:for="{{aiKeywords}}"
                  wx:key="key"
                  type="primary"
                  size="medium"
                  round
                  custom-class="keyword-tag-item custom-tag-primary"
                >
                  {{item.value}}
                </van-tag>
              </view>
              <view class="keywords-placeholder" wx:else>
                                  <block wx:if="{{extractError}}">
                  <van-icon name="warning" size="32rpx" color="#ee0a24" />
                  <text class="error-text">{{extractError}}</text>
                </block>
                <block wx:elif="{{isExtractingKeywords}}">
                  <!-- <view class="custom-loading"></view> -->
                  <text class="loading-text">AI正在提取关键词中...，用时 {{currentAnalysisTime}} 秒</text>
                </block>
              </view>
            </view>
          </van-card>

          <view class="suggestion-title-text">
            <text>分析结果建议</text>
          </view>
          <view class="suggestion-content">
            <view class="suggestion-item">
              <text>AI已成功提取融资需求关键词，点击"让AI生成融资建议报告"获取完整融资建议。</text>
            </view>
            <view class="suggestion-item">
              <text>若对关键词提取结果不满意，可"重新分析"或点击"新的需求"按钮来重新填写客户融资需求。</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</scroll-view>

<!-- 征信报告分析结果弹层 -->
<van-popup
  show="{{showCreditReportPopup}}"
  position="bottom"
  round
  custom-style="height: 85vh; background-color: #f5f7fa;"
  bind:close="closeCreditReportPopup"
  close-on-click-overlay="{{true}}"
  safe-area-inset-bottom="{{true}}"
  z-index="999"
>
  <view class="credit-report-popup">
    <!-- 弹层头部 -->
    <view class="popup-header">
      <view class="header-left">
        <text class="popup-title">选择征信报告分析结果</text>
        <van-icon
          name="info-o"
          size="18px"
          color="#303133"
          class="info-icon"
          bind:click="showPopupInfo"
        />
      </view>
      <van-icon
        name="cross"
        size="20px"
        color="#303133"
        class="close-icon"
        bind:click="closeCreditReportPopup"
      />
    </view>

    <!-- 搜索筛选区域 -->
    <view class="search-container">
      <view class="search-filter-row">
        <!-- 搜索框 -->
        <view class="search-input-wrapper">
          <van-search
            value="{{searchForm.customerName}}"
            placeholder="请输入客户姓名"
            bind:change="onCustomerNameChange"
            bind:search="onSearch"
            bind:clear="onClearCustomerName"
            shape="round"
            background="#ffffff"
            custom-class="search-input"
          />
        </view>

        <!-- 筛选下拉菜单 -->
        <view class="filter-dropdown-wrapper">
          <van-dropdown-menu>
            <van-dropdown-item
              value="{{searchForm.taskResults}}"
              options="{{dropdownOptions}}"
              bind:change="onTaskResultChange"
              title-class="dropdown-title"
              popup-class="dropdown-popup"
            />
          </van-dropdown-menu>
        </view>
      </view>
    </view>

    <!-- 列表内容区域 -->
    <scroll-view
      scroll-y="true"
      class="list-scroll-view"
      refresher-enabled="{{true}}"
      refresher-triggered="{{refreshing}}"
      bind:refresherrefresh="onRefresh"
      bind:scrolltoupper="onScrollToUpper"
      upper-threshold="50"
    >
      <view class="task-list">
        <!-- 征信报告列表 -->
        <view wx:if="{{displayedCreditReportList.length > 0}}">
          <view
            wx:for="{{displayedCreditReportList}}"
            wx:key="id"
            class="task-card {{item.isSelected ? 'selected' : ''}}"
            bind:tap="onTaskCardTap"
            data-item="{{item}}"
          >
            <!-- 状态标签 -->
            <view class="custom-status-tag">
              <view class="status-tag {{item.statusClass}}">
                {{item.result}}
              </view>
            </view>

            <!-- 选择框 -->
            <view class="task-checkbox">
              <van-checkbox
                value="{{item.isSelected}}"
                disabled="{{item.isDisabled}}"
                bind:change="onTaskSelect"
                data-item="{{item}}"
                checked-color="#1b68de"
                icon-size="20px"
              />
            </view>

            <!-- 卡片头部 -->
            <view class="card-header">
              <view class="task-type">
                <text class="type-text">{{item.customerName}}</text>
                <van-tag
                  type="{{item.type.includes('个人征信') ? 'primary' : 'warning'}}"
                  size="small"
                  class="type-tag"
                >
                  {{item.type.includes('个人征信') ? '个人征信' : '企业征信'}}
                </van-tag>
              </view>
            </view>

            <!-- 卡片内容 -->
            <view class="card-content">
              <view class="info-row">
                <text class="info-text">{{item.type}}</text>
              </view>
            </view>

            <!-- 卡片底部 -->
            <view class="card-footer">
              <view class="time-info">
                <text class="time-label">{{item.endTime ? '完成时间：' : '提交时间：'}}</text>
                <text class="time-value">{{item.endTime || item.submitTime || '未知'}}</text>
              </view>
            </view>

            <!-- 卡片操作 -->
            <view class="card-actions">
              <text
                wx:if="{{item.result === '已出结果'}}"
                class="view-result-link"
                bind:tap="onViewResult"
                data-item="{{item}}"
                catchtap="true"
              >
                查看结果
              </text>
              <van-button
                wx:elif="{{item.result && item.result.includes('排队中')}}"
                type="warning"
                size="small"
                bind:click="onCancelTask"
                data-item="{{item}}"
                custom-class="action-btn"
                catchtap="true"
              >
                取消任务
              </van-button>
              <text
                wx:elif="{{item.result && item.result.includes('进行中')}}"
                class="status-text"
              >
                进行中...
              </text>
              <van-button
                wx:elif="{{item.result && item.result.includes('任务失败')}}"
                type="danger"
                size="small"
                bind:click="onShowFailReason"
                data-item="{{item}}"
                custom-class="action-btn"
                catchtap="true"
              >
                查看原因
              </van-button>
            </view>
          </view>
        </view>

        <!-- 空状态 -->
        <view wx:else class="empty-state">
          <van-empty
            image="search"
            description="{{tableDataLoading ? '正在搜索...' : (searchForm.customerName || searchForm.taskResults !== '已出结果' ? '没找到符合条件的征信报告' : '暂无征信报告分析结果')}}"
          >
            <view class="empty-actions">
              <text class="empty-tip">
                {{searchForm.customerName || searchForm.taskResults !== '已出结果' ? '尝试调整搜索条件' : '可前去发起征信分析，获得结果后再回来选择'}}
              </text>
              <van-button
                wx:if="{{searchForm.customerName || searchForm.taskResults !== '已出结果'}}"
                type="primary"
                size="small"
                bind:click="onResetSearch"
                custom-class="reset-search-btn"
              >
                重置搜索条件
              </van-button>
            </view>
          </van-empty>
        </view>

        <!-- 加载状态 -->
        <van-loading
          wx:if="{{tableDataLoading}}"
          type="spinner"
          class="loading-overlay"
        >
          正在搜索历史任务...
        </van-loading>

        <!-- 加载更多提示 -->
        <view wx:if="{{hasMore && !isLoading}}" class="load-more-tip">
          <text>向上滑动加载更多</text>
        </view>
        <view wx:if="{{!hasMore && displayedCreditReportList.length > 0}}" class="no-more-tip">
          <text>已加载全部数据</text>
        </view>
      </view>
    </scroll-view>
  </view>
</van-popup>

