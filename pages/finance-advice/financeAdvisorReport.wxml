<navigation-bar id="nav-bar" title="èèµ„å»ºè®®æŠ¥å‘Š" background="#f8f9fa" bind:back="onBack"></navigation-bar>
<scroll-view scroll-y="true" class="scroll-container" style="height: {{scrollViewHeight}}">
  <view class="finance-advisor-report">
    <!-- å¤„ç†æ­¥éª¤åŒºåŸŸ -->
    <view class="steps-header" wx:if="{{activeStep > 1}}">
      <view class="steps">
        <view class="step {{activeStep >= 1 ? 'active' : ''}} {{activeStep > 1 ? 'completed' : ''}}">
          <view class="step-icon">1</view>
          <view class="step-title">æäº¤å®¢æˆ·éœ€æ±‚</view>
        </view>
        <view class="step-line {{activeStep >= 2 ? 'active' : ''}}"></view>
        <view class="step {{activeStep >= 2 ? 'active' : ''}} {{activeStep > 2 ? 'completed' : ''}}" wx:if="{{hasCreditReport}}">
          <view class="step-icon">2</view>
          <view class="step-title">AIåˆ†æå¾ä¿¡æŠ¥å‘Š</view>
        </view>
        <view class="step-line {{activeStep >= 3 ? 'active' : ''}}" wx:if="{{hasCreditReport}}"></view>
        <view class="step {{(hasCreditReport && activeStep >= 3) || (!hasCreditReport && activeStep >= 2) ? 'active' : ''}} {{(hasCreditReport && activeStep > 3) || (!hasCreditReport && activeStep > 2) ? 'completed' : ''}}">
          <view class="step-icon">{{hasCreditReport ? '3' : '2'}}</view>
          <view class="step-title">åŒ¹é…é‡‘èäº§å“</view>
        </view>
        <view class="step-line {{(hasCreditReport && activeStep >= 4) || (!hasCreditReport && activeStep >= 3) ? 'active' : ''}}"></view>
        <view class="step {{(hasCreditReport && activeStep >= 4) || (!hasCreditReport && activeStep >= 3) ? 'active' : ''}}">
          <view class="step-icon">{{hasCreditReport ? '4' : '3'}}</view>
          <view class="step-title">èèµ„å»ºè®®æŠ¥å‘Š</view>
        </view>
      </view>
    </view>
    
    <!-- å„æ­¥éª¤å¯¹åº”çš„å†…å®¹åŒºåŸŸ -->
    <view class="step-content">
      <!-- æ­¥éª¤2: AIåˆ†æå¾ä¿¡æŠ¥å‘Š -->
      <view wx:if="{{hasCreditReport && activeStep === 2}}" class="step-container">
        <view class="placeholder-content">
          <view class="loading-icon">ğŸ”„</view>
          <text class="loading-text">AIæ­£åœ¨åˆ†æå®¢æˆ·å¾ä¿¡æŠ¥å‘Šï¼Œè¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...</text>
        </view>
      </view>
      
      <!-- æ­¥éª¤3: åŒ¹é…é‡‘èäº§å“ -->
      <view wx:if="{{(hasCreditReport && activeStep === 3) || (!hasCreditReport && activeStep === 2)}}" class="step-container">
        <view class="ai-thinking-container">
          <!-- åŒ¹é…äº§å“çš„è’™å±‚ -->
          <view wx:if="{{workingStatus === 'working'}}" class="working-overlay">
            <view class="overlay-content">
              <view class="animation-container">
                <view class="loading-brain">ğŸ§ </view>
                <view class="loading-dots">
                  <view class="dot"></view>
                  <view class="dot"></view>
                  <view class="dot"></view>
                </view>
                <view class="wait-footer">
                  <view class="ai-tip">æ­£åœ¨ç­‰å¾…AIå“åº”ï¼Œè¯·ç¨ç­‰...</view>
                  <view class="ai-timer">â±ï¸ å·²è€—æ—¶ {{workingTimer}} ç§’</view>
                </view>
              </view>
            </view>
          </view>

          <!-- AIæ€è€ƒè¿‡ç¨‹å†…å®¹å®¹å™¨ -->
          <view wx:if="{{workingStatus === 'thinking' || workingStatus === 'generating'}}" class="thinking-container">
            <view class="panel-header">
              <text class="panel-title">
                ğŸ§  <text wx:if="{{isThinking}}" class="thinking-status">AIæ­£åœ¨æ·±åº¦æ€è€ƒä¸­...</text>
                <text wx:elif="{{workingStatus === 'generating'}}" class="thinking-completed">AIæ€è€ƒå·²å®Œæˆã€‚</text>
              </text>
            </view>
            <view class="panel-content">
              <!-- æŠ¥å‘Šç”Ÿæˆè¿‡æ¸¡æç¤º -->
              <view wx:if="{{workingStatus === 'generating'}}" class="generating-overlay">
                <view class="generating-content">
                  <view class="loading-spinner">ğŸ”„</view>
                  <view class="generating-message">å³å°†ç”Ÿæˆèèµ„å»ºè®®æŠ¥å‘Š...</view>
                </view>
              </view>
              
              <view class="thinking-display {{workingStatus === 'generating' ? 'dimmed' : ''}}">
                <text class="thinking-text">{{displayedThinkingProcess}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- æ­¥éª¤4: ç”Ÿæˆèèµ„æŠ¥å‘Š -->
      <view wx:if="{{(hasCreditReport && activeStep === 4) || (!hasCreditReport && activeStep === 3)}}" class="step-container">
        <view class="report-container">
          <view class="report-layout">
            <!-- å·¦ä¾§AIåˆ†æç»“æœ -->
            <view class="report-left">
              <view class="panel-header">
                <text class="panel-title">
                  ğŸ“„ èèµ„é¡¾é—®æŠ¥å‘Š
                  <text wx:if="{{reportGenerationDuration > 0}}" class="report-duration">è€—æ—¶{{reportGenerationDuration}}ç§’</text>
                </text>
                <view class="header-actions">
                  <button wx:if="{{reportContent}}" class="action-button download-btn" bindtap="downloadReport">
                    ğŸ’¾ ä¸‹è½½æŠ¥å‘Š
                  </button>
                  <button wx:if="{{reportContent}}" class="action-button restart-btn" bindtap="restartAdvisor">
                    ğŸ  æ–°çš„ä»»åŠ¡
                  </button>
                </view>
              </view>
              <view class="panel-content">
                <view class="report-content">
                  <text class="report-text">{{reportContent}}</text>
                </view>
              </view>
            </view>
            
            <!-- å³ä¾§åŒºåŸŸï¼ˆAIæ€è€ƒè¿‡ç¨‹å’Œå’¨è¯¢ï¼‰-->
            <view class="report-right">
              <!-- ä¸Šéƒ¨åˆ†ï¼šAIæ€è€ƒè¿‡ç¨‹ -->
              <view class="report-right-top">
                <view class="panel-header">
                  <text class="panel-title">ğŸ§  AIæ·±åº¦æ€è€ƒè¿‡ç¨‹</text>
                </view>
                <view class="panel-content">
                  <view class="thinking-content">
                    <text wx:if="{{workThinkingContent}}" class="work-thinking">{{workThinkingContent}}</text>
                  </view>
                </view>
              </view>
              
              <!-- ä¸‹éƒ¨åˆ†ï¼šç»§ç»­å‘AIå’¨è¯¢ -->
              <view class="report-right-bottom">
                <view class="panel-header">
                  <text class="panel-title">
                    ğŸ’¬ ç»§ç»­å‘AIå’¨è¯¢
                    <text wx:if="{{consultationThinkingTimer > 0}}" class="thinking-status">
                      AIæ­£åœ¨å›å¤ä¸­ {{consultationThinkingTimer}}ç§’
                    </text>
                    <text wx:elif="{{consultationResponseStatus}}" class="response-status">
                      {{consultationResponseStatus}} è€—æ—¶{{consultationResponseTime}}ç§’
                    </text>
                  </text>
                </view>
                
                <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
                <view class="chat-messages">
                  <view wx:for="{{consultationMessages}}" wx:key="index" class="message {{item.role}}">
                    <view wx:if="{{item.role === 'assistant'}}" class="message-avatar">AI</view>
                    <view class="message-content">
                      <text class="message-text">{{item.content}}</text>
                    </view>
                  </view>
                  
                  <!-- AIå›å¤æ€è€ƒä¸­åŠ¨ç”» -->
                  <view wx:if="{{consultationLoading}}" class="message assistant thinking">
                    <view class="message-avatar">AI</view>
                    <view class="message-content">
                      <view class="thinking-indicator">
                        <view class="thinking-dot"></view>
                        <view class="thinking-dot"></view>
                        <view class="thinking-dot"></view>
                      </view>
                    </view>
                  </view>
                </view>

                <!-- èŠå¤©è¾“å…¥æ¡† -->
                <view class="chat-input">
                  <view class="input-container">
                    <textarea
                      class="message-input"
                      placeholder="è¯·è¾“å…¥ä½ è¦å’¨è¯¢çš„å†…å®¹..."
                      value="{{consultationInput}}"
                      bindinput="onConsultationInput"
                      auto-height
                      maxlength="500"
                    />
                    <button 
                      class="send-button {{consultationInput.trim() && !consultationLoading ? '' : 'disabled'}}" 
                      bindtap="sendConsultationMessage"
                      disabled="{{!consultationInput.trim() || consultationLoading}}"
                    >
                      ğŸ“¤
                    </button>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</scroll-view> 