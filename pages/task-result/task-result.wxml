<!-- 任务结果查看器页面 -->
<view class="task-result-page">
  <!-- 自定义导航栏 -->
  <navigation-bar 
    title="{{ taskDetail ? taskDetail.type : '任务结果' }}" 
    back="{{true}}"
    background="#1b68de"
    color="#ffffff"
  >
    <view slot="right" class="nav-right">
      <van-icon 
        name="ellipsis" 
        size="20px" 
        color="#ffffff"
        bind:click="showActionMenu"
      />
    </view>
  </navigation-bar>

  <!-- 页面内容 -->
  <view class="page-content">
    <!-- 加载状态 -->
    <view class="loading-container" wx:if="{{ loading }}">
      <van-loading type="spinner" size="24px" color="#1b68de">加载中...</van-loading>
    </view>

    <!-- 错误状态 -->
    <view class="error-container" wx:elif="{{ loadError }}">
      <van-empty 
        image="error" 
        description="{{ loadError }}"
      >
        <van-button 
          type="primary" 
          size="small"
          bind:click="loadTaskDetail"
        >
          重新加载
        </van-button>
      </van-empty>
    </view>

    <!-- 任务详情内容 -->
    <view class="task-content" wx:else>
      <!-- 任务基本信息 -->
      <view class="task-info-section">
        <van-cell-group>
          <van-cell 
            title="客户姓名" 
            value="{{ taskDetail.customerName || '未填写' }}"
            wx:if="{{ taskDetail.customerName }}"
          />
          <van-cell 
            title="任务类型" 
            value="{{ taskDetail.type }}"
          />
          <van-cell 
            title="提交时间" 
            value="{{ taskDetail.submitTime }}"
          />
          <van-cell 
            title="完成时间" 
            value="{{ taskDetail.endTime || '处理中' }}"
          />
          <van-cell 
            title="处理时长" 
            value="{{ reportGenerationDuration }}秒"
            wx:if="{{ reportGenerationDuration > 0 }}"
          />
        </van-cell-group>
      </view>

      <!-- 标签页内容 -->
      <view class="tabs-container">
        <van-tabs 
          active="{{ activeTab }}" 
          bind:change="onTabChange"
          color="#1b68de"
          title-active-color="#1b68de"
          title-inactive-color="#969799"
        >
          <!-- 分析报告标签页 -->
          <van-tab title="分析报告">
            <view class="tab-content report-tab">
              <view
                class="report-content"
                bind:longpress="onReportLongPress"
              >
                <text
                  class="markdown-content"
                  selectable="{{true}}"
                >{{ reportContent }}</text>
              </view>
            </view>
          </van-tab>

          <!-- AI思考标签页 -->
          <van-tab title="AI思考">
            <view class="tab-content thinking-tab">
              <view class="thinking-content">
                <text class="markdown-content">{{ aiThinkingProcess }}</text>
              </view>
            </view>
          </van-tab>

          <!-- 继续咨询标签页 -->
          <van-tab title="继续咨询">
            <view class="tab-content consultation-tab">
              <!-- 可滚动的消息列表 -->
              <scroll-view
                class="consultation-messages"
                id="consultation-messages"
                scroll-y="{{true}}"
                scroll-into-view="{{scrollIntoView}}"
                enable-back-to-top="{{false}}"
              >
                <view 
                  class="message-item {{ item.type }}-message"
                  wx:for="{{ consultationMessages }}"
                  wx:key="id"
                >
                  <view class="message-avatar">
                    <text class="avatar-text">{{ item.type === 'user' ? '我' : 'AI' }}</text>
                  </view>
                  <view class="message-content">
                    <view class="message-text">{{ item.content }}</view>
                    <view class="message-time">{{ item.time }}</view>
                  </view>
                </view>

                <!-- AI回复加载状态 -->
                <view class="message-item ai-message" wx:if="{{ consultationLoading }}">
                  <view class="message-avatar">
                    <text class="avatar-text">AI</text>
                  </view>
                  <view class="message-content">
                    <view class="typing-indicator">
                      <van-loading type="spinner" size="16px" color="#1b68de" />
                      <text class="typing-text">AI正在思考中...</text>
                    </view>
                  </view>
                </view>

                <!-- 空状态 -->
                <view class="empty-consultation" wx:if="{{ consultationMessages.length === 0 && !consultationLoading }}">
                  <van-empty
                    image="chat-o"
                    description="开始与AI助手对话吧"
                  />
                </view>

                <!-- 滚动锚点 -->
                <view id="message-bottom"></view>
              </scroll-view>

              <!-- 输入区域 -->
              <view class="consultation-input-area">
                <view class="input-container">
                  <van-field
                    value="{{ consultationInput }}"
                    placeholder="请输入您的问题..."
                    type="textarea"
                    autosize
                    maxlength="500"
                    show-word-limit
                    bind:input="onConsultationInput"
                    bind:confirm="sendConsultationMessage"
                  />
                  <van-button 
                    type="primary" 
                    size="small"
                    disabled="{{ !consultationInput.trim() || consultationLoading }}"
                    bind:click="sendConsultationMessage"
                    class="send-button"
                  >
                    发送
                  </van-button>
                </view>
              </view>
            </view>
          </van-tab>
        </van-tabs>
      </view>
    </view>
  </view>

  <!-- 操作菜单 -->
  <van-action-sheet
    show="{{ showActionSheet }}"
    actions="{{ actionSheetActions }}"
    bind:close="hideActionMenu"
    bind:select="onActionSelect"
    cancel-text="取消"
  />
</view>
