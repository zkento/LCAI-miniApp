<navigation-bar id="nav-bar" title="个人征信分析报告" background="#f8f9fa" bind:back="onBack"></navigation-bar>

<view class="credit-analyse-report">
  <!-- 处理步骤区域 - 只在第一步之后显示 -->
  <view class="steps-header" wx:if="{{activeStep > 1}}">
    <van-steps active="{{activeStep - 1}}" direction="horizontal">
      <van-step>上传征信文件</van-step>
      <van-step>处理征信内容</van-step>
      <van-step>AI思考分析</van-step>
      <van-step>征信分析报告</van-step>
    </van-steps>
  </view>

  <!-- 各步骤对应的内容区域 -->
  <view class="step-content">
    <!-- 步骤2: 提取文本内容 -->
    <view wx:if="{{activeStep === 2}}" class="step-container">
      <view class="extraction-layout">
        <!-- 左侧显示原文件 -->
        <view class="original-file">
          <view class="panel-header">
            <text class="header-title">原始文件</text>
            <text class="file-name">
              {{fileList.length ? (fileList[0].name + (fileList.length > 1 ? '等' + fileList.length + '个文件' : '')) : '未知文件'}}
            </text>
          </view>
          <view class="panel-content">
            <view wx:if="{{filePreviewUrl}}" class="file-preview">
              <image wx:if="{{isImageFile}}" src="{{filePreviewUrl}}" mode="aspectFit" class="preview-image"/>
              <web-view wx:else src="{{filePreviewUrl}}" class="preview-webview"></web-view>
            </view>
            <view wx:else class="file-placeholder">
              <image class="placeholder-icon" src="/assets/images/file_icon.png"/>
              <text class="placeholder-text">文件加载中...</text>
            </view>
          </view>
        </view>

        <!-- 右侧显示提取的文本 -->
        <view class="extracted-text">
          <view class="panel-header">
            <text class="header-title">提取的文本内容</text>
            <text class="extraction-progress">{{extractionProgress}}%</text>
          </view>
          <view class="panel-content">
            <view wx:if="{{isExtracting}}" class="extraction-loading">
              <van-loading type="spinner" size="24px" color="#1989fa"/>
              <text class="loading-text">正在提取文本内容...</text>
            </view>
            <scroll-view wx:else scroll-y="true" class="text-content">
              <text class="extracted-content">{{extractedText || '等待提取文本内容...'}}</text>
            </scroll-view>
          </view>
        </view>
      </view>

      <!-- 悬浮操作按钮 -->
      <view class="floating-actions">
        <button class="floating-btn" bindtap="viewUploadedFile">
          <van-icon name="eye-o" size="20px"/>
        </button>
      </view>
    </view>

    <!-- 步骤3: AI思考分析 -->
    <view wx:if="{{activeStep === 3}}" class="step-container">
      <view class="thinking-layout">
        <view class="thinking-header">
          <view class="thinking-title">
            <van-icon name="cpu" size="20px" color="#1989fa"/>
            <text>AI正在思考分析</text>
          </view>
          <view class="thinking-timer">
            <van-icon name="clock-o" size="16px" color="#969799"/>
            <text>{{workingTimer}}秒</text>
          </view>
        </view>
        
        <view class="thinking-content">
          <scroll-view scroll-y="true" class="thinking-process" scroll-into-view="{{thinkingScrollTarget}}">
            <view class="thinking-text">
              <text class="thinking-label">思考过程：</text>
              <text class="thinking-content-text">{{displayedThinkingProcess}}</text>
              <text wx:if="{{isThinking}}" class="thinking-cursor">|</text>
            </view>
            <view id="thinking-bottom" class="scroll-anchor"></view>
          </scroll-view>
        </view>
      </view>
    </view>

    <!-- 步骤4: 征信分析报告 -->
    <view wx:if="{{activeStep === 4}}" class="step-container">
      <view class="report-layout">
        <view class="report-header">
          <text class="report-title">征信分析报告</text>
          <view class="report-actions">
            <van-button type="default" size="small" bindtap="viewCreditFile">
              <van-icon name="eye-o" size="14px"/>
              查看征信文件
            </van-button>
            <van-button type="primary" size="small" bindtap="shareReport">
              <van-icon name="share" size="14px"/>
              分享报告
            </van-button>
          </view>
        </view>

        <view class="report-content">
          <view class="report-text">
            <rich-text nodes="{{reportContentHtml}}"></rich-text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
